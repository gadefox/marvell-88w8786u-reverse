# pool_event_flags_alloc

pool_get(gpool)
pool = gpool.poole
~ pool.alloc_count == 11 && exit(1F)
tx_semaphore_get(pool.sema)

node = pool.free_head
~ node != null:
  pool.free_head = node.next
  node.next = null

node.prev = null

~ pool.used_tail == null:
  pool.used_tail = node
  node.next = null
!~:
  pool.used_tail.prev = node
  node.next = pool.used_tail
  pool.used_tail = node

pool.alloc_count++
tx_semaphore_put(pool.sema)

vprintf3(buf, "OsFlg%d", pool.id_counter++)
ret = tx_event_flags_create(node, buf, *C00013B)
~ ret == 0:
  memclear(node, 20h)

  *node_ret = node
  exit(0)

# cleanup
tx_semaphore_get(pool.sema)

pool.alloc_count--

~ node.prev != null && node.prev.next = node.next || pool.used_tail = node.next
~ node.next != null && node.next.prev = node.prev

node.prev = null

node.next = pool.free_head
pool.free_head = node

tx_semaphore_put(pool.sema)
exit(ret)
