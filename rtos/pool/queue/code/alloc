# pool_queue_alloc

pool_get(gpool)
pool = gpool.poolq
~ pool.alloc_count == 5 && exit(1C)
tx_semaphore_get(pool.sema)

node = pool.free_head
~ node != null:
  pool.free_head = node.next
  node.next = null

node.prev = null

~ pool.used_tail == null:
  pool.used_tail = node
  node.next = null
!~:
  pool.used_tail.prev = node
  node.next = pool.used_tail
  pool.used_tail = node

pool.alloc_count++
tx_semaphore_put(pool.sema)

ret = queue_create(block, name, msg_size, num_msgs, null)
~ ret == 0:
  node.restype = 0
  node.parent = pool

  *node_ret = node
  exit(0)

# cleanup
tx_semaphore_get(pool.sema)

pool.alloc_count--

~ node.prev != null && node.prev.next = node.next || pool.used_tail = node.next
~ node.next != null && node.next.prev = node.prev

node.prev = null

node.next = pool.free_head
pool.free_head = node

tx_semaphore_put(pool.sema)
exit(ret)
